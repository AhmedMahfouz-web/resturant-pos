<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Real-time Inventory Dashboard</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
            20px;
                background-color: #f5f5f5;
            }

            .dashboard {
                max-width: 1200px;
                margin: 0 auto;
            }

            .dashboard-header {
                background: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .connection-status {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
            }

            .connection-status.connected {
                background-color: #d4edda;
                color: #155724;
            }

            .connection-status.disconnected {
                background-color: #f8d7da;
                color: #721c24;
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }

            .dashboard-card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .dashboard-card h3 {
                margin: 0 0 15px 0;
                color: #333;
            }

            .summary-stats {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .stat-item {
                text-align: center;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
            }

            .stat-value {
                font-size: 24px;
                font-weight: bold;
                color: #007bff;
            }

            .stat-label {
                font-size: 12px;
                color: #666;
                margin-top: 5px;
            }

            .material-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border-bottom: 1px solid #eee;
                transition: background-color 0.3s;
            }

            .material-item:last-child {
                border-bottom: none;
            }

            .material-item.updated {
                background-color: #fff3cd;
            }

            .material-quantity {
                font-weight: bold;
                transition: color 0.3s;
            }

            .material-quantity.updated {
                color: #007bff;
            }

            .low-stock-indicator {
                background-color: #dc3545;
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
            }

            .alert-item {
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 4px;
                border-left: 4px solid;
            }

            .alert-low_stock {
                background-color: #fff3cd;
                border-left-color: #ffc107;
            }

            .alert-out_of_stock {
                background-color: #f8d7da;
                border-left-color: #dc3545;
            }

            .alert-expiry_warning {
                background-color: #d1ecf1;
                border-left-color: #17a2b8;
            }

            .alert-expiry_critical {
                background-color: #f8d7da;
                border-left-color: #dc3545;
            }

            .notifications-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 300px;
            }

            .alert-notification {
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                margin-bottom: 10px;
                padding: 15px;
                border-left: 4px solid #007bff;
                animation: slideIn 0.3s ease-out;
            }

            .alert-notification.alert-low_stock {
                border-left-color: #ffc107;
            }

            .alert-notification.alert-out_of_stock {
                border-left-color: #dc3545;
            }

            .alert-notification.alert-expiry_warning {
                border-left-color: #17a2b8;
            }

            .alert-notification.alert-expiry_critical {
                border-left-color: #dc3545;
            }

            .alert-close {
                position: absolute;
                top: 5px;
                right: 10px;
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                color: #999;
            }

            .alert-close:hover {
                color: #333;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            .last-updated {
                font-size: 11px;
                color: #999;
            }

            .refresh-button {
                background: #007bff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 10px;
            }

            .refresh-button:hover {
                background: #0056b3;
            }
        </style>
    </head>
    <body>
        <div class="dashboard">
            <div class="dashboard-header">
                <h1>Real-time Inventory Dashboard</h1>
                <span
                    id="connection-status"
                    class="connection-status disconnected"
                    >Disconnected</span
                >
                <button class="refresh-button" onclick="refreshDashboard()">
                    Refresh
                </button>
                <div class="last-updated">
                    Last updated: <span id="last-updated-time">Never</span>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Summary Statistics -->
                <div class="dashboard-card">
                    <h3>Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div
                                class="stat-value"
                                data-summary="total_materials"
                            >
                                0
                            </div>
                            <div class="stat-label">Total Materials</div>
                        </div>
                        <div class="stat-item">
                            <div
                                class="stat-value"
                                data-summary="low_stock_count"
                            >
                                0
                            </div>
                            <div class="stat-label">Low Stock</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" data-summary="total_alerts">
                                0
                            </div>
                            <div class="stat-label">Active Alerts</div>
                        </div>
                        <div class="stat-item">
                            <div
                                class="stat-value"
                                data-summary="total_stock_value"
                            >
                                $0
                            </div>
                            <div class="stat-label">Stock Value</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="dashboard-card">
                    <h3>Recent Alerts</h3>
                    <div class="recent-alerts-list">
                        <p>No recent alerts</p>
                    </div>
                </div>

                <!-- Low Stock Materials -->
                <div class="dashboard-card">
                    <h3>Low Stock Materials</h3>
                    <div class="low-stock-materials-list">
                        <p>No low stock materials</p>
                    </div>
                </div>
            </div>

            <!-- Materials List -->
            <div class="dashboard-card">
                <h3>Materials Inventory</h3>
                <div id="materials-list">
                    <p>Loading materials...</p>
                </div>
            </div>
        </div>

        <!-- Notifications Container -->
        <div class="notifications-container"></div>

        <!-- Include required libraries -->
        <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.0/dist/echo.iife.js"></script>
        <script src="/js/inventory-realtime.js"></script>

        <script>
            // Dashboard functionality
            let dashboardData = {};

            // Initialize dashboard
            document.addEventListener("DOMContentLoaded", function () {
                // Set up connection status updates
                window.inventoryClient.on("connected", function () {
                    document.getElementById("connection-status").textContent =
                        "Connected";
                    document.getElementById("connection-status").className =
                        "connection-status connected";
                    loadDashboardData();
                });

                window.inventoryClient.on("disconnected", function () {
                    document.getElementById("connection-status").textContent =
                        "Disconnected";
                    document.getElementById("connection-status").className =
                        "connection-status disconnected";
                });

                // Set up dashboard updates
                window.inventoryClient.on("dashboard.updated", function (data) {
                    console.log("Dashboard updated via WebSocket:", data);
                    updateLastUpdatedTime();
                });

                // Set up inventory updates
                window.inventoryClient.on("inventory.updated", function (data) {
                    console.log("Inventory updated:", data);
                    updateMaterialInList(data);
                    updateLastUpdatedTime();
                });

                // Set up stock alerts
                window.inventoryClient.on(
                    "stock-alert.triggered",
                    function (data) {
                        console.log("Stock alert triggered:", data);
                        updateLastUpdatedTime();
                    }
                );

                // Load initial data
                loadDashboardData();
                loadMaterialsList();
            });

            // Load dashboard data from API
            async function loadDashboardData() {
                try {
                    const response = await fetch(
                        "/api/inventory/realtime/dashboard"
                    );
                    const result = await response.json();

                    if (result.success) {
                        dashboardData = result.data;
                        updateDashboardDisplay();
                        updateLastUpdatedTime();
                    }
                } catch (error) {
                    console.error("Failed to load dashboard data:", error);
                }
            }

            // Load materials list
            async function loadMaterialsList() {
                try {
                    const response = await fetch(
                        "/api/inventory/realtime/status"
                    );
                    const result = await response.json();

                    if (result.success) {
                        updateMaterialsList(result.data.materials);
                        updateSummaryStats(result.data.summary);
                    }
                } catch (error) {
                    console.error("Failed to load materials list:", error);
                }
            }

            // Update dashboard display
            function updateDashboardDisplay() {
                if (dashboardData.summary) {
                    updateSummaryStats(dashboardData.summary);
                }

                if (dashboardData.recent_alerts) {
                    updateRecentAlerts(dashboardData.recent_alerts);
                }

                if (dashboardData.low_stock_materials) {
                    updateLowStockMaterials(dashboardData.low_stock_materials);
                }
            }

            // Update summary statistics
            function updateSummaryStats(summary) {
                Object.keys(summary).forEach((key) => {
                    const element = document.querySelector(
                        `[data-summary="${key}"]`
                    );
                    if (element) {
                        let value = summary[key];
                        if (key === "total_stock_value") {
                            value = "$" + parseFloat(value).toFixed(2);
                        }
                        element.textContent = value;
                    }
                });
            }

            // Update recent alerts
            function updateRecentAlerts(alerts) {
                const container = document.querySelector(".recent-alerts-list");
                if (alerts.length === 0) {
                    container.innerHTML = "<p>No recent alerts</p>";
                    return;
                }

                container.innerHTML = alerts
                    .map(
                        (alert) => `
                <div class="alert-item alert-${alert.alert_type}">
                    <strong>${alert.material_name}</strong>
                    <p>${alert.message}</p>
                    <small>${new Date(
                        alert.created_at
                    ).toLocaleString()}</small>
                </div>
            `
                    )
                    .join("");
            }

            // Update low stock materials
            function updateLowStockMaterials(materials) {
                const container = document.querySelector(
                    ".low-stock-materials-list"
                );
                if (materials.length === 0) {
                    container.innerHTML = "<p>No low stock materials</p>";
                    return;
                }

                container.innerHTML = materials
                    .map(
                        (material) => `
                <div class="material-item">
                    <strong>${material.name}</strong>
                    <div>
                        <span class="quantity">${material.quantity} ${material.stock_unit}</span>
                        <br>
                        <small>Reorder at: ${material.reorder_point}</small>
                    </div>
                </div>
            `
                    )
                    .join("");
            }

            // Update materials list
            function updateMaterialsList(materials) {
                const container = document.getElementById("materials-list");

                if (materials.length === 0) {
                    container.innerHTML = "<p>No materials found</p>";
                    return;
                }

                container.innerHTML = materials
                    .map(
                        (material) => `
                <div class="material-item" data-material-id="${material.id}">
                    <div>
                        <strong>${material.name}</strong>
                        <div class="last-updated">Last updated: ${new Date(
                            material.last_updated
                        ).toLocaleString()}</div>
                    </div>
                    <div>
                        <span class="material-quantity">${material.quantity} ${
                            material.stock_unit
                        }</span>
                        ${
                            material.is_low_stock
                                ? '<span class="low-stock-indicator">LOW STOCK</span>'
                                : ""
                        }
                        ${
                            material.is_overstock
                                ? '<span class="low-stock-indicator" style="background-color: #ffc107;">OVERSTOCK</span>'
                                : ""
                        }
                    </div>
                </div>
            `
                    )
                    .join("");
            }

            // Update specific material in list
            function updateMaterialInList(data) {
                const materialElement = document.querySelector(
                    `[data-material-id="${data.material_id}"]`
                );
                if (materialElement) {
                    const quantityElement =
                        materialElement.querySelector(".material-quantity");
                    if (quantityElement) {
                        quantityElement.textContent = `${data.new_quantity} ${data.stock_unit}`;
                        quantityElement.classList.add("updated");
                        setTimeout(
                            () => quantityElement.classList.remove("updated"),
                            2000
                        );
                    }

                    materialElement.classList.add("updated");
                    setTimeout(
                        () => materialElement.classList.remove("updated"),
                        2000
                    );
                }
            }

            // Update last updated time
            function updateLastUpdatedTime() {
                document.getElementById("last-updated-time").textContent =
                    new Date().toLocaleString();
            }

            // Refresh dashboard manually
            function refreshDashboard() {
                loadDashboardData();
                loadMaterialsList();
            }

            // Auto-refresh every 30 seconds
            setInterval(refreshDashboard, 30000);
        </script>
    </body>
</html>
